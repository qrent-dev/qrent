name: Deploy to Test Environment

on:
  push:
    branches: [ v2.0 ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install pnpm
      run: npm install -g pnpm

    - name: Install dependencies
      run: pnpm install

    - name: Build backend
      run: |
        cd packages/backend
        pnpm build

    - name: Build frontend
      env:
        NEXT_PUBLIC_BACKEND_URL: ${{ vars.NEXT_PUBLIC_BACKEND_URL }}
      run: |
        cd packages/frontend
        pnpm build

    - name: Deploy to DigitalOcean
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: 22
        script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /qrent
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git fetch origin
          git checkout v2.0
          git pull origin v2.0
          
          # åœæ­¢çŽ°æœ‰æœåŠ¡
          docker-compose down || true
          
          # æ›´æ–°çŽ¯å¢ƒå˜é‡
          cat > .env << EOF
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          HOST="${{ vars.HOST_BIND }}"
          PORT="${{ vars.PORT }}"
          EXPOSE_PORT="${{ vars.EXPOSE_PORT }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          API_KEY="${{ secrets.API_KEY }}"
          NSW_TRANSPORT_API_KEY="${{ secrets.NSW_TRANSPORT_API_KEY }}"
          PROPERTY_RATING_API_KEY="${{ secrets.PROPERTY_RATING_API_KEY }}"
          MYSQL_DATABASE="${{ vars.MYSQL_DATABASE }}"
          MYSQL_ROOT_PASSWORD="${{ secrets.MYSQL_ROOT_PASSWORD }}"
          MYSQL_PROPERTY_USER_PASSWORD="${{ secrets.MYSQL_PROPERTY_USER_PASSWORD }}"
          NODE_ENV="${{ vars.NODE_ENV }}"
          DB_HOST="${{ vars.DB_HOST }}"
          DB_USER="${{ vars.DB_USER }}"
          DB_PASSWORD="${{ secrets.MYSQL_PROPERTY_USER_PASSWORD }}"
          DB_DATABASE="${{ vars.DB_DATABASE }}"
          DB_PORT="${{ vars.DB_PORT }}"
          NEXT_PUBLIC_BACKEND_URL="${{ vars.NEXT_PUBLIC_BACKEND_URL }}"
          EOF
          
          # é‡æ–°æž„å»ºå¹¶å¯åŠ¨æœåŠ¡
          docker-compose build --no-cache
          docker-compose up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          docker-compose ps
          
          # å¥åº·æ£€æŸ¥
          curl -f http://localhost:3201/health || echo "Backend health check failed"
          curl -f http://localhost:3000 || echo "Frontend health check failed"
          
          # æ˜¾ç¤ºæ—¥å¿—
          docker-compose logs --tail=20

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment to test environment successful!"
          echo "ðŸŒ Frontend: http://209.38.19.70:3000"
          echo "ðŸ”— Backend: http://209.38.19.70:3201"
        else
          echo "âŒ Deployment failed!"
        fi